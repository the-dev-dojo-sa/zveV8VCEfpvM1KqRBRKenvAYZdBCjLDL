name: Build Installer

on:
  workflow_dispatch:
    inputs:
      runtime:
        description: "Target runtime (e.g. linux-x64)"
        required: true
        type: string
      version:
        description: "Version (e.g. 0.0.1)"
        required: true
        type: string
      src_url:
        description: "URL to download build files"
        required: true
        type: string
      dst_url:
        description: "URL to upload final installer"
        required: true
        type: string

jobs:
  build-win-x64:
    if: github.event.inputs.runtime == 'win-x64'
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download build files
        run: |
          curl -o build.zip "${{ github.event.inputs.src_url }}"
          unzip build.zip -d ./build

      - name: Create installer
        run: echo "Hey there, I am using WhatsApp" > test.txt

      - name: Upload installer
        run: |
          curl -X POST -F "installer=@test.txt" "${{ github.event.inputs.dst_url }}" \
          -H 'Authorization: Basic ${{ secrets.NACHERT_API_KEY }}'

  build-linux-x64:
    if: github.event.inputs.runtime == 'linux-x64'
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download build files
        run: |
          curl -o build.zip "${{ github.event.inputs.src_url }}"
          unzip build.zip -d ./build

      - name: Replace versions
        run: |
          sed -i "s/{AppVersion}/${{ github.event.inputs.version }}/g" "Installers/linux-x64/debpkg/usr/share/applications/Nachert.desktop"
          sed -i "s/{AppVersion}/${{ github.event.inputs.version }}/g" "Installers/linux-x64/debpkg/DEBIAN/control"

      - name: Build deb package
        run: |
          cp -r build Installers/linux-x64/debpkg/opt/TheDevDojo/Nachert
          chmod 755 Installers/linux-x64/debpkg/DEBIAN/postinst
          chmod 755 Installers/linux-x64/debpkg/DEBIAN/prerm
          
          dpkg-deb --build Installers/linux-x64/debpkg

      - name: Upload installer
        run: |
          curl -X POST -F "installer=@Installers/linux-x64/debpkg.deb" "${{ github.event.inputs.dst_url }}" \
          -H 'Authorization: Basic ${{ secrets.NACHERT_API_KEY }}'

  build-osx-x64:
    if: github.event.inputs.runtime == 'osx-x64'
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Download build files
        run: |
          curl -o build.zip "${{ github.event.inputs.src_url }}"
          unzip build.zip -d ./build

      - name: Create installer
        run: echo "Hey there, I am using WhatsApp" > test.txt

      - name: Upload installer
        run: |
          curl -X POST -F "installer=@test.txt" "${{ github.event.inputs.dst_url }}" \
          -H 'Authorization: Basic ${{ secrets.NACHERT_API_KEY }}'
